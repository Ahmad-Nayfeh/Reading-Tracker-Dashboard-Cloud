import streamlit as st
import gspread
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import Flow
from google.auth.transport.requests import Request
import db_manager as db
from googleapiclient.discovery import build

SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive.file",
    "https://www.googleapis.com/auth/forms.body",
    "openid",
    "https://www.googleapis.com/auth/userinfo.profile",
    "https://www.googleapis.com/auth/userinfo.email"
]

def get_redirect_uri():
    """
    Determines the correct redirect URI based on the execution environment.
    """
    try:
        from streamlit.web.server.server import Server
        # When running on Streamlit Cloud, the server address will contain 'streamlit.app'
        is_cloud = "streamlit.app" in Server.get_current()._get_server_address_for_browser()
    except (ImportError, AttributeError):
        # Fallback for different environments or streamlit versions, assume local
        is_cloud = False

    creds_dict = dict(st.secrets["google_oauth_credentials"])
    redirect_uris = creds_dict.get('redirect_uris', [])

    if is_cloud:
        return next((uri for uri in redirect_uris if 'streamlit.app' in uri), None)
    else:
        return next((uri for uri in redirect_uris if 'localhost' in uri), redirect_uris[0] if redirect_uris else None)


def authenticate():
    """
    Handles the authentication flow using st.secrets for configuration.
    It prioritizes credentials stored in the current session.
    """
    # Priority 1: Check for valid credentials in the current session state
    if 'credentials' in st.session_state and st.session_state.credentials.valid:
        return st.session_state.credentials

    # Check if secrets are configured
    if "google_oauth_credentials" not in st.secrets:
        st.error("ğŸ”‘ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:** Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ `google_oauth_credentials` ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø± (secrets.toml).")
        st.stop()

    # Configure the OAuth flow using st.secrets
    creds_dict = dict(st.secrets["google_oauth_credentials"])
    redirect_uri = get_redirect_uri()

    if not redirect_uri:
        st.error("ğŸ”‘ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:** Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ `redirect_uri` Ù…Ù†Ø§Ø³Ø¨ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø± (secrets.toml).")
        st.stop()

    flow = Flow.from_client_config(
        client_config={'web': creds_dict},
        scopes=SCOPES,
        redirect_uri=redirect_uri
    )
    
    # Check for the authorization code in the URL query parameters
    authorization_code = st.query_params.get("code")
    
    if authorization_code:
        # If we have a code, fetch the token
        flow.fetch_token(code=authorization_code)
        creds = flow.credentials
        
        # Store credentials in the session state
        st.session_state.credentials = creds
        
        # Get user info and set up the workspace if it's the first time
        try:
            userinfo_service = build('oauth2', 'v2', credentials=creds)
            user_info = userinfo_service.userinfo().get().execute()
            
            user_id = user_info.get('id')
            user_email = user_info.get('email')

            if not user_id or not user_email:
                st.error("Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬ÙˆØ¬Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
                st.stop()

            st.session_state.user_id = user_id
            st.session_state.user_email = user_info.get('email')

            if not db.check_user_exists(user_id):
                with st.spinner("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©..."):
                    db.create_new_user_workspace(user_id, user_email)
            
        except Exception as e:
            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„: {e}")
            st.stop()
        
        # Clear the query parameters from the URL and rerun the app
        st.query_params.clear()
        st.rerun()
    
    else:
        # If there are no credentials and no code, show the login button
        auth_url, _ = flow.authorization_url(prompt='consent')
        st.title("ğŸš€ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ \"Ù…Ø§Ø±Ø§Ø«ÙˆÙ† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©\"")
        st.info("Ù„Ù„Ø¨Ø¯Ø¡ØŒ ÙŠØ±Ø¬Ù‰ Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ø¬ÙˆØ¬Ù„. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø³Ø­Ø§Ø¨ÙŠØ© Ø®Ø§ØµØ© Ø¨Ùƒ Ù„Ø¥Ø¯Ø§Ø±Ø© ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©.")
        st.link_button("ğŸ”— **Ø§Ù„Ø±Ø¨Ø· Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„ ÙˆØ§Ù„Ø¨Ø¯Ø¡**", auth_url, use_container_width=True, type="primary")
        st.stop()

@st.cache_resource
def get_gspread_client(user_id: str, _creds: Credentials):
    """
    Creates a unique gspread client for each user.
    """
    if not _creds or not _creds.valid:
        st.error("ğŸ”’ **Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:** Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ ØµØ§Ù„Ø­Ø©.")
        st.stop()
    return gspread.authorize(_creds)
